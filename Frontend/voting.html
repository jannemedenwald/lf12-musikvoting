<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Axe and Fire | Vote</title>
  <link href="https://fonts.googleapis.com/css2?family=Megrim&family=Inter:wght@300;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body class="voting-page">

  <div class="content-wrapper">
    <p class="user-greeting">WELCOME, <span id="display-name">GUEST</span></p>

    <h1 class="main-title">VOTE NOW</h1>
    <p class="subtitle">Last 5 votes count. Choose wisely.</p>

    <form class="login-container add-track-form" id="musicForm">
      <div class="input-group">
        <input type="text" id="bandInput" placeholder="Band Name" required>
      </div>
      <div class="input-group">
        <input type="text" id="songInput" placeholder="Song Title" required>
      </div>
      <div class="input-group">
        <input type="text" id="genreInput" placeholder="Genre" required>
      </div>
      <button type="submit" class="login-btn" style="margin-top: 20px;">ADD TRACK</button>
    </form>

    <div class="table-container">
      <table class="music-table" id="musicTable">
        <thead>
          <tr>
            <th>Band</th>
            <th>Song</th>
            <th>Genre</th>
            <th>Vote</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <div class="button-group">
      <a href="results.html" class="action-btn">See Results</a>

      <button class="action-btn" onclick="window.location.href='index.html'">Change User</button>

      <button class="action-btn btn-danger-hover"
        onclick="if(confirm('Reset all data?')){localStorage.clear(); location.reload();}">Reset All Data</button>

    </div>
  </div>
  </div>

  <script>
    // 1. Initialize session data
    const currentUser = sessionStorage.getItem('userName') || 'Guest';
    const myId = sessionStorage.getItem('myId');
    document.getElementById('display-name').innerText = currentUser.toUpperCase();

    const musicForm = document.getElementById('musicForm');
    const musicTable = document.getElementById('musicTable').getElementsByTagName('tbody')[0];
    const API_URL = 'http://localhost:8080/api';

    // 2. Load all songs from server (GET /api/songs)
    async function loadSongs() {
      try {
        const response = await fetch(`${API_URL}/songs`);
        const songs = await response.json();
        renderTable(songs);
      } catch (error) {
        console.error('Error loading songs:', error);
      }
    }

    // 3. Render table using IDs from the database
    function renderTable(songs) {
      musicTable.innerHTML = '';
      songs.forEach((item) => {
        const newRow = musicTable.insertRow();
        newRow.innerHTML = `
            <td>${item.band}</td>
            <td>${item.titel}</td> <td>${item.genre}</td>
            <td><button class="mini-vote-btn" onclick="addVote('${item.id}')">+</button></td>
        `;
      });
    }

    // 4. Add new song (POST /api/song)
    musicForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      if (!myId) {
        alert("Session expired. Please login again.");
        window.location.href = 'index.html';
        return;
      }

      const songData = {
        gastId: myId,
        titel: document.getElementById('songInput').value,
        band: document.getElementById('bandInput').value,
        genre: document.getElementById('genreInput').value
      };

      try {
        const response = await fetch(`${API_URL}/song`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(songData)
        });

        if (response.ok) {
          musicForm.reset();
          loadSongs(); // Refresh list from server
        } else {
          alert("Error saving song. Check backend constraints.");
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    // 5. Submit vote (POST /api/vote)
    window.addVote = async function (songId) {
      if (!myId) {
        alert("Please login to vote.");
        return;
      }

      const voteRequest = {
        gastId: myId,
        songId: songId
      };

      try {
        const response = await fetch(`${API_URL}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(voteRequest)
        });

        if (response.ok) {
          alert(`Vote recorded!`);
        } else {
          alert("Vote failed. You might have exceeded your limit.");
        }
      } catch (error) {
        console.error('Voting error:', error);
      }
    };

    loadSongs();
  </script>
</body>

</html>
