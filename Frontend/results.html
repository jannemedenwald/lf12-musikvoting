<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Axe and Fire | Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Megrim&family=Inter:wght@300;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body class="voting-page">

  <div class="content-wrapper">
    <h1 class="main-title">Playlist</h1>
    <p class="subtitle">Based on the last 5 votes of each guest</p>

    <div id="output" class="playlist-results">
    </div>

    <div class="button-group">
      <a href="voting.html" class="action-btn">Back to Voting</a>
      <button class="action-btn" onclick="window.location.href='index.html'">Change User</button>
    </div>
  </div>

  <script>
    function displayResults() {
      const output = document.getElementById('output');

      // 1. Get raw data from storage

      /**
   * --- JAVA BACKEND INTEGRATION (Business Logic) ---
   * CURRENT: JavaScript processes the "Last 5" filter.
   * FUTURE: 
   * - The backend Service Layer (Java) will calculate the results.
   * - Logic: Using JPQL or Native SQL to fetch only the 5 most recent votes per user.
   * - The frontend will simply receive a clean List<TrackDTO> via a GET request (@GetMapping).
   */


      const playlist = JSON.parse(localStorage.getItem('partyPlaylist')) || [];
      const allVotes = JSON.parse(localStorage.getItem('allVotes')) || {};

      // 2. Calculation logic
      let finalCounts = {};

      // Process each user individually
      Object.keys(allVotes).forEach(user => {
        // Strict Rule: Slice ONLY the last 5 actions of this user
        const userHistory = allVotes[user];
        const userLastFive = userHistory.slice(-5);

        userLastFive.forEach(trackIndex => {
          // Add to the total count for this track
          finalCounts[trackIndex] = (finalCounts[trackIndex] || 0) + 1;
        });
      });

      // 3. Transform into displayable array
      let results = [];
      playlist.forEach((item, index) => {
        // Rule: Only show if the track has at least 1 valid vote from the "last 5" filter
        if (finalCounts[index] > 0) {
          results.push({
            band: item.band,
            song: item.song,
            genre: item.genre,
            votes: finalCounts[index]
          });
        }
      });

      // 4. Sort: Most votes at the top
      results.sort((a, b) => b.votes - a.votes);

      // 5. Render to HTML
      output.innerHTML = ''; // Force clear before rendering

      if (results.length === 0) {
        output.innerHTML = '<p class="subtitle">No valid votes yet. Go back and vote!</p>';
        return;
      }

      results.forEach((item, index) => {
        const isWinner = index === 0 ? 'winner' : '';
        output.innerHTML += `
          <div class="result-card ${isWinner}">
            <div class="vote-badge">${item.votes}</div>
            <div class="track-meta">
              <h3>${item.band}</h3>
              <p>${item.song} | ${item.genre}</p>
            </div>
          </div>`;
      });
    }

    // Run calculation on load
    displayResults();
  </script>
</body>

</html>